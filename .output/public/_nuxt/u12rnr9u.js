import{_ as ae}from"./CizdsbHW.js";import{az as ie,_ as re,E as oe,D as ce,r as m,G as le,Q as de,g as ue,h as _e,L as pe,z as L,a4 as z,o,c,a as t,i as g,b as C,t as f,m as b,F as K,s as F,q,aA as he,A as H,d as W,x as me,ae as G,v as fe,C as ve}from"./BEkH225l.js";const xe=ie("chat",{state:()=>({isChatOpen:!1,isChatLoading:!1,owner:null,recipient:null,unreadMessages:0}),actions:{toggleChat(){this.isChatOpen=!this.isChatOpen},openChat(){this.isChatOpen=!0},closeChat(){this.isChatOpen=!1},setChatOwner(y){this.owner=y},setChatRecipient(y){this.recipient=y}}}),ge={class:"fixed bottom-5 right-5 flex items-end space-x-2"},be={class:"absolute bottom-5 right-5 px-4 pb-2 flex gap-2 align-middle items-center text-sm bg-primary text-accent hover:bg-blue-900 rounded-full"},ye={key:0,class:"w-full border rounded-lg flex flex-col font-sans"},we={class:"flex items-center justify-between p-3 bg-gray-100 border-b rounded-t-md"},Ce={class:"flex gap-2 items-center"},ke={class:"flex items-center"},Se={class:"ml-1"},De={class:"block font-bold"},Le={class:"text-sm text-gray-500"},qe={class:"flex-1 p-3 overflow-y-auto bg-white"},Ee={key:0,class:"text-center py-2"},Ne={key:1,class:"text-center py-2"},Me={class:"text-gray-400 text-sm"},Oe={key:2,class:"max-h-[200px] overflow-y-auto pr-2",id:"chat-window"},Te={class:"flex items-center p-3 bg-gray-100 border-t rounded-b-md"},Ue={key:1,class:"w-full border rounded-lg flex flex-col font-sans"},$e={class:"flex justify-between items-center p-3 bg-primary rounded-t-md"},je={class:"block font-bold text-white flex gap-2"},Ae={class:"flex items-center p-3 bg-white rounded-t-md"},Be={class:"flex items-center flex-1 border rounded-md bg-gray-100"},Re={class:"flex-1 px-3 overflow-y-auto bg-white rounded-b-md pb-3"},Ve={key:0,class:"text-center text-gray-400 flex flex-col items-center justify-center py-4"},Ie={key:0,class:"flex flex-col items-center"},ze={key:1,class:"text-gray-400 text-sm"},Ke={key:1,class:"max-h-[200px]"},Fe=["onClick"],He={class:"flex items-center w-full"},We={class:"flex flex-col flex-grow pl-3"},Ge={class:"flex justify-between items-center flex-grow"},Je={class:"font-bold flex items-center"},Qe={key:0,class:"bg-red-600 text-white text-xs px-2 ml-1 rounded-full"},Ye={class:"text-gray-300 text-sm"},Pe={key:0,class:"text-xs text-green-500 mt-1"},Xe={__name:"Chat",props:{username:{type:String,default:"Indah Risky"},userAvatar:{type:String,default:"https://via.placeholder.com/50"},isChatShow:{type:Boolean,default:!1}},setup(y){var B,R;const{$supabase:d}=me(),v=xe();oe();const J=ce(),k=m(""),_=m([]),p=m([]),w=m(""),i=m(null),Q=m("Available"),E=m(!1),N=m(!1);let M=null,O=null,u=null;const S=le("token");if(S.value)try{u=((R=(B=S.value)==null?void 0:B.user)==null?void 0:R.chat_owner_id)||null}catch(s){console.error("Error parsing token:",s)}const x=de(()=>_.value.sort((e,a)=>{const l=e.recipient_last_chat_datetime?new Date(e.recipient_last_chat_datetime):new Date(0);return(a.recipient_last_chat_datetime?new Date(a.recipient_last_chat_datetime):new Date(0))-l}).filter(e=>e.recipient_name.toLowerCase().includes(k.value.toLowerCase()))),$=async()=>{var a;E.value=!0;const{data:s,error:e}=await d.from("contacts").select("*").eq("owner_id",u);if(e)console.error("Error fetching contacts:",e);else{_.value=((a=s[0])==null?void 0:a.contacts)||[],_.value.forEach(r=>{r.is_active=r.recipient_id===u}),localStorage.setItem("chat-cache",JSON.stringify(_.value));const l=_.value.reduce((r,n)=>r+n.recipient_unread_count,0);v.unreadMessages=l,E.value=!1}},T=async()=>{try{const{data:s,error:e}=await d.from("chats").select("*").or(`and(sender_id.eq.${u},recipient_id.eq.${i.value.recipient_id}),and(sender_id.eq.${i.value.recipient_id},recipient_id.eq.${u})`).order("id",{ascending:!0});if(e)throw e;if(p.value=s||[],G(()=>{const a=document.querySelector("#chat-window");a&&(a.scrollTop=a.scrollHeight)}),i.value){const a=_.value.map(r=>r.recipient_id===i.value.recipient_id?{...r,recipient_unread_count:0,recipient_is_open:!0}:r),{error:l}=await d.from("contacts").update({contacts:a}).eq("owner_id",u);l&&console.error("Error updating contact:",l)}}catch(s){console.error("Error fetching messages:",s)}},j=async()=>{var U,V;if(!w.value.trim()){console.log("Message is empty, not sending.");return}const s={message:w.value,sender_id:u,sender_name:(U=S.value)==null?void 0:U.user.fullname,sender_picture:(V=S.value)==null?void 0:V.user.photo,recipient_id:i.value.recipient_id,recipient_name:i.value.recipient_name,recipient_picture:i.value.recipient_picture,is_read:!1,created_at:new Date},{error:e}=await d.from("chats").insert([s]);if(e){console.error("Error sending message:",e);return}p.value.push(s),w.value="";const a=_.value.map(h=>h.recipient_id===i.value.recipient_id?{...h,recipient_last_chat:s.message,recipient_last_chat_datetime:s.created_at,recipient_is_open:!0,recipient_unread_count:0}:h),{error:l}=await d.from("contacts").update({contacts:a}).eq("owner_id",s.sender_id);l&&console.error("Error updating sender contact:",l);const{data:r,error:n}=await d.from("contacts").select("*").eq("owner_id",s.recipient_id);if(n&&console.error("Error fetching recipient contact:",n),r&&r[0]){const ne=(r[0].contacts||[]).map(D=>D.recipient_id===s.sender_id?{...D,recipient_last_chat:s.message,recipient_last_chat_datetime:s.created_at,recipient_is_open:!1,recipient_unread_count:D.recipient_unread_count+1}:D),{error:I}=await d.from("contacts").update({contacts:ne}).eq("owner_id",s.recipient_id);I&&console.error("Error updating recipient contact:",I)}G(()=>{const h=document.querySelector("#chat-window");h&&(h.scrollTop=h.scrollHeight)})},Y=s=>{i.value=s,T()},A=()=>{i.value=null,v.closeChat()},P=async()=>{const s=_.value.map(a=>a.recipient_id===i.value.recipient_id?{...a,recipient_last_chat:p.value[p.value.length-1].message,recipient_last_chat_datetime:p.value[p.value.length-1].created_at,recipient_is_open:!0,recipient_unread_count:0}:a),{error:e}=await d.from("contacts").update({contacts:s}).eq("owner_id",u);e&&console.error("Error updating contact:",e),i.value=null},X=()=>{J.push({name:"facilitators"})},Z=s=>{const e=new Date(s),a=new Date,l=e.toDateString()===a.toDateString(),r=Math.floor((a-e)/(1e3*60*60*24));return l?e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"}):r===1?"Yesterday":r<7?e.toLocaleDateString(void 0,{weekday:"long"}):e.toLocaleDateString()},ee=s=>s.length>30?s.substring(0,30)+"...":s,te=()=>{M=d.channel("contacts-changes").on("postgres_changes",{event:"*",schema:"public",table:"contacts",filter:`owner_id=eq.${u}`},s=>{$()}).subscribe()},se=()=>{O=d.channel("chats-changes").on("postgres_changes",{event:"*",schema:"public",table:"chats"},s=>{T()}).subscribe()};return ue(()=>v.recipient,s=>{s&&(i.value=_.value.find(e=>e.recipient_id===s.id),T())}),_e(()=>{$(),te(),se()}),pe(()=>{M&&d.removeChannel(M),O&&d.removeChannel(O)}),(s,e)=>{const a=ae,l=fe,r=ve;return L((o(),c("div",ge,[t("div",null,[L(t("div",be,e[2]||(e[2]=[t("span",{class:"text-xl text-white dot-animation"},".",-1),t("span",{class:"text-xl text-white dot-animation"},".",-1),t("span",{class:"text-xl text-white dot-animation"},".",-1)]),512),[[z,g(v).isChatLoading&&g(v).isChatOpen]])]),!g(v).isChatLoading&&i.value?(o(),c("div",ye,[t("div",we,[t("div",Ce,[t("div",null,[t("button",{class:"text-xl font-bold text-gray-500 hover:text-black",onClick:P},[C(a,{name:"back",class:"text-2xl",filled:""})])]),t("div",ke,[C(l,{size:"xl",alt:i.value.recipient_name,src:i.value.recipient_picture,imgClass:"rounded-full object-cover"},null,8,["alt","src"]),t("div",Se,[t("span",De,f(i.value.recipient_name),1),t("span",Le,f(Q.value),1)])])]),t("button",{class:"text-xl font-bold text-gray-500 hover:text-black",onClick:A}," × ")]),t("div",qe,[N.value?(o(),c("div",Ee,e[3]||(e[3]=[t("span",{class:"text-gray-400 text-sm"},"Loading messages...",-1)]))):b("",!0),p.value.length===0&&!N.value?(o(),c("div",Ne,[t("span",Me," Start a conversation with "+f(i.value.recipient_name),1)])):b("",!0),p.value.length!==0&&!N.value?(o(),c("div",Oe,[(o(!0),c(K,null,F(p.value,n=>(o(),c("div",{key:n.id,class:q([{"text-right":n.sender_id===g(u),"text-left":n.sender_id!==g(u)},"my-2"])},[t("span",{class:q(["inline-block px-3 py-2 rounded-lg bg-accent text-white",{"bg-primary text-white":n.sender_id===g(u)}])},f(n.message),3)],2))),128))])):b("",!0)]),t("div",Te,[L(t("input",{"onUpdate:modelValue":e[0]||(e[0]=n=>w.value=n),onKeyup:he(j,["enter"]),type:"text",placeholder:"Type your message",class:"flex-1 border rounded-md px-3 py-2 mr-2"},null,544),[[H,w.value]]),t("button",{onClick:j,class:"bg-primary text-white px-3 py-2 rounded-md hover:bg-blue-600"}," Send ")])])):b("",!0),!g(v).isChatLoading&&!i.value?(o(),c("div",Ue,[t("div",$e,[t("span",je,[C(a,{name:"chat",class:"text-2xl text-white"}),e[4]||(e[4]=W(" Live Chat"))]),t("button",{class:"text-xl font-bold text-gray-500 hover:text-black",onClick:A}," × ")]),t("div",Ae,[t("div",Be,[L(t("input",{"onUpdate:modelValue":e[1]||(e[1]=n=>k.value=n),type:"text",placeholder:"Search",class:"flex-1 px-3 py-2 bg-transparent outline-none"},null,512),[[H,k.value]]),C(r,{name:"i-heroicons-magnifying-glass",class:"w-5 h-5 mr-3 text-gray-600"})])]),t("div",Re,[x.value.length===0&&!E.value?(o(),c("div",Ve,[k.value?(o(),c("span",ze,"No results found")):(o(),c("div",Ie,[e[5]||(e[5]=t("span",{class:"text-gray-400 text-sm"},"No contacts found",-1)),t("button",{onClick:X,class:"bg-blue-500 text-white px-3 py-2 rounded-md hover:bg-blue-600 text-sm mt-2"}," Start Conversation ")]))])):(o(),c("div",Ke,[(o(!0),c(K,null,F(x.value,n=>(o(),c("div",{key:n.recipient_id,class:q(["flex items-center justify-between p-3 w-full cursor-pointer hover:bg-gray-100",{"border-b":n!==x.value[x.value.length-1],"rounded-t-md":n===x.value[0],"rounded-b-md":n===x.value[x.value.length-1]}]),onClick:U=>Y(n)},[t("div",He,[C(l,{alt:n.recipient_name,src:n.recipient_picture,imgClass:" rounded-full object-cover",class:"w-10 h-10"},null,8,["alt","src"]),t("div",We,[t("div",Ge,[t("span",Je,[W(f(n.recipient_name)+" ",1),n.recipient_unread_count>0?(o(),c("span",Qe,f(n.recipient_unread_count>10?"New":n.recipient_unread_count),1)):b("",!0)]),t("span",Ye,f(n.recipient_last_chat_datetime!==""?Z(n.recipient_last_chat_datetime):"New"),1)]),t("span",{class:q(["text-sm",n.recipient_is_open?"text-gray-400":"font-semibold text-gray-800"])},f(n.recipient_last_chat!==""?ee(n.recipient_last_chat):"No messages yet"),3),n.is_active?(o(),c("span",Pe," Online ")):b("",!0)])])],10,Fe))),128))]))])])):b("",!0)],512)),[[z,y.isChatShow]])}}},tt=re(Xe,[["__scopeId","data-v-9d97195a"]]);export{tt as _,xe as u};
